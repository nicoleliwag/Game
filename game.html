<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beat Tap Revolution</title>
  <style>
    /* General layout */
    body {
      font-family: 'Comic Sans MS', cursive;
      background-color: #ffe6f0;
      margin: 0;
      position: relative;
      overflow: hidden;
    }
    /* Home page & Game page containers */
    #home-page, #game-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 20px;
    }
    #game-page {
      display: none;
    }
    h1 {
      color: #ff66b2;
      margin-bottom: 10px;
    }
    /* Hamburger menu styling */
    #menu {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
      z-index: 10;
    }
    #menu-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #fff0f5;
      border: 1px solid #ff66b2;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 10;
      top: 40px;
    }
    .menu-item {
      padding: 10px 20px;
      color: #d63384;
      font-family: 'Comic Sans MS', cursive;
      cursor: pointer;
    }
    .menu-item:hover {
      background-color: #ff66b2;
      color: white;
    }
    /* Home page song select styling */
    #song-select {
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #ff66b2;
      background-color: #fff0f5;
      color: #d63384;
      font-family: 'Comic Sans MS', cursive;
      margin-bottom: 10px;
      font-size: 16px;
      width: 80%;
      max-width: 400px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background-color: #ff66b2;
      color: white;
      font-family: 'Comic Sans MS', cursive;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 18px;
      margin: 5px;
    }
    button:hover {
      background-color: #ff3399;
    }
    /* Game page ‚Äì play controls & settings panel */
    #play-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #settings-panel {
      display: none;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }
    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }
    .slider-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 45%;
    }
    .slider-label {
      margin-bottom: 5px;
      color: #d63384;
    }
    input[type="range"] {
      width: 100%;
    }
    #score {
      font-size: 24px;
      color: #d63384;
      margin-bottom: 15px;
    }
    /* Game stage styles */
    #game-stage {
      position: relative;
      width: 360px;
      height: 480px;
      background-color: rgba(255, 102, 178, 0.1);
      border: 2px solid #ff66b2;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .lane {
      position: absolute;
      top: 0;
      height: 100%;
      width: 120px;
      border-right: 1px dashed #ff66b2;
    }
    .lane:last-child {
      border-right: none;
    }
    .target-zone {
      position: absolute;
      bottom: 60px;
      height: 40px;
      width: 100%;
      background-color: rgba(255, 102, 178, 0.2);
      border-top: 2px solid #ff3399;
      border-bottom: 2px solid #ff3399;
      z-index: 1;
    }
    .lane-key {
      position: absolute;
      bottom: 10px;
      width: 80px;
      height: 40px;
      background-color: #ff66b2;
      border-radius: 5px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 2;
      left: 50%;
      transform: translateX(-50%);
    }
    .note {
      position: absolute;
      width: 80px;
      height: 30px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: white;
      z-index: 3;
      left: 50%;
      transform: translateX(-50%);
    }
    .note-circle {
      background-color: #ff3399;
      clip-path: circle(40%);
    }
    .note-star {
      background-color: #ffcc00;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
    }
    .note-square {
      background-color: #66ccff;
    }
    .hit-effect {
      position: absolute;
      width: 100px;
      height: 100px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #ff3399;
      z-index: 5;
      transform: scale(0);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .combo-display {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 36px;
      color: #ff3399;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .feedback {
      position: absolute;
      font-size: 32px;
      font-weight: bold;
      transform: translateY(0) scale(1);
      opacity: 1;
      transition: transform 0.5s, opacity 0.5s;
    }
    .feedback.perfect {
      color: gold;
    }
    .feedback.good {
      color: #00cc00;
    }
    .feedback.ok {
      color: #3399ff;
    }
    .feedback.miss {
      color: #ff0000;
    }
    .feedback.hidden {
      transform: translateY(-50px) scale(1.5);
      opacity: 0;
    }
    /* Difficulty select */
    #difficulty-select {
      display: flex;
      margin-bottom: 20px;
    }
    .difficulty-btn {
      padding: 8px 15px;
      margin: 0 5px;
      background-color: #fff0f5;
      border: 1px solid #ff66b2;
      color: #d63384;
    }
    .difficulty-btn.active {
      background-color: #ff66b2;
      color: white;
    }
    /* Visualization & instructions */
    #visualization {
      width: 300px;
      height: 60px;
      background-color: rgba(255, 102, 178, 0.1);
      margin-top: 15px;
      position: relative;
      border-radius: 5px;
    }
    #threshold-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background-color: #ff3399;
      z-index: 1;
    }
    #energy-bar {
      position: absolute;
      bottom: 0;
      width: 20px;
      background-color: #ff66b2;
    }
    #status, #instructions, #debug-info, #debug-toggle {
      margin-top: 10px;
      color: #d63384;
    }
    #debug-info {
      font-size: 12px;
      display: none;
    }
    #debug-toggle {
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
    }
    /* Results screen */
    #results-screen {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 230, 240, 0.9);
      z-index: 10;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .results-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 102, 178, 0.5);
      text-align: center;
      max-width: 400px;
    }
    .result-stat {
      margin: 10px 0;
      font-size: 20px;
    }
    .grade {
      font-size: 72px;
      font-weight: bold;
      margin: 20px 0;
    }
    .grade-S {
      color: gold;
    }
    .grade-A {
      color: #00cc00;
    }
    .grade-B {
      color: #3399ff;
    }
    .grade-C {
      color: #ff9900;
    }
    .grade-D {
      color: #ff0000;
    }
  </style>
</head>
<body>
  <!-- Home Page -->
  <div id="home-page">
    <h1>üíÉ Beat Tap Revolution üï∫</h1>
    <p>Select a song to play:</p>
    <select id="song-select">
      <optgroup label="Rock (80-100 BPM)">
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">SoundHelix Rock 1</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">SoundHelix Rock 2</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">SoundHelix Rock 3</option>
      </optgroup>
      
      <optgroup label="Electronic (85-95 BPM)">
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3">Chill Electronica</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3">Ambient Beats</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3">Downtempo Groove</option>
      </optgroup>
      
      <optgroup label="Pop (75-90 BPM)">
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3">Pop Ballad</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3">Soft Pop</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3">Mellow Pop</option>
      </optgroup>
      
      <optgroup label="Jazz (70-85 BPM)">
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3">Smooth Jazz</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3">Cool Jazz</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3">Jazz Lounge</option>
      </optgroup>
      
      <optgroup label="Classical (60-80 BPM)">
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3">Classical Adagio</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3">Piano Sonata</option>
        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3">Orchestral Piece</option>
      </optgroup>
    </select>
    
    <div id="difficulty-select">
      <button class="difficulty-btn active" data-difficulty="easy">Easy</button>
      <button class="difficulty-btn" data-difficulty="medium">Medium</button>
      <button class="difficulty-btn" data-difficulty="hard">Hard</button>
    </div>
    
    <button id="start-game">Start Game</button>
    
    <div id="instructions">
      <p>Press the keys when notes reach the target zone!</p>
      <p>Left Lane: A or ‚Üê<br>
         Middle Lane: S or ‚Üì<br>
         Right Lane: D or ‚Üí</p>
    </div>
  </div>

  <!-- Game Page -->
  <div id="game-page">
    <!-- Hamburger Menu -->
    <div id="menu">
      ‚ò∞
      <div id="menu-content">
        <div class="menu-item" id="menu-restart">Restart</div>
        <div class="menu-item" id="menu-home">Home</div>
        <div class="menu-item" id="menu-settings">Settings</div>
      </div>
    </div>
    
    <h1>üíÉ Beat Tap Revolution üï∫</h1>
    <div id="score">Score: <span id="score-value">0</span></div>
    
    <!-- Play Controls -->
    <div id="play-controls">
      <div class="button-group">
        <button id="play">Play</button>
        <button id="pause">Pause</button>
      </div>
    </div>
    
    <!-- Settings Panel -->
    <div id="settings-panel">
      <div class="control-row">
        <div class="slider-control">
          <div class="slider-label">Note Speed: <span id="speed-value">5</span></div>
          <input type="range" id="speed" min="1" max="10" value="5">
        </div>
        <div class="slider-control">
          <div class="slider-label">Sensitivity: <span id="sensitivity-value">5</span></div>
          <input type="range" id="sensitivity" min="1" max="10" value="5">
        </div>
      </div>
      <div class="control-row">
        <div class="slider-control">
          <div class="slider-label">Min Interval: <span id="interval-value">300</span>ms</div>
          <input type="range" id="interval" min="50" max="1000" step="10" value="300">
        </div>
        <div class="slider-control">
          <div class="slider-label">Bass Cutoff: <span id="cutoff-value">150</span>Hz</div>
          <input type="range" id="cutoff" min="50" max="500" step="10" value="150">
        </div>
      </div>
    </div>
    
    <!-- Game Stage -->
    <div id="game-stage">
      <div class="lane" style="left: 0px;">
        <div class="lane-key">A</div>
      </div>
      <div class="lane" style="left: 120px;">
        <div class="lane-key">S</div>
      </div>
      <div class="lane" style="left: 240px;">
        <div class="lane-key">D</div>
      </div>
      <div class="target-zone"></div>
      <div class="combo-display">Combo: <span id="combo-counter">0</span></div>
    </div>
    
    <div id="status">Press Play to start!</div>
    
    <div id="visualization">
      <div id="threshold-line"></div>
      <div id="energy-bar"></div>
    </div>
    
    <div id="debug-toggle">Show Debug Info</div>
    <div id="debug-info">
      Current Energy: <span id="current-energy">0</span><br>
      Threshold: <span id="current-threshold">0</span><br>
      Beats Detected: <span id="beats-detected">0</span>
    </div>
    
    <!-- Results Screen -->
    <div id="results-screen">
      <div class="results-content">
        <h2>Game Results</h2>
        <div class="grade">A</div>
        <div class="result-stat">Score: <span id="final-score">0</span></div>
        <div class="result-stat">Perfect: <span id="perfect-count">0</span></div>
        <div class="result-stat">Good: <span id="good-count">0</span></div>
        <div class="result-stat">OK: <span id="ok-count">0</span></div>
        <div class="result-stat">Miss: <span id="miss-count">0</span></div>
        <div class="result-stat">Max Combo: <span id="max-combo">0</span></div>
        <button id="retry-button">Play Again</button>
        <button id="home-button">Back to Home</button>
      </div>
    </div>
  </div>

  <script>
    // Global variable for selected song and difficulty
    let selectedSong = "";
    let selectedDifficulty = "easy";
    
    // Difficulty buttons event listeners
    const difficultyButtons = document.querySelectorAll('.difficulty-btn');
    difficultyButtons.forEach(button => {
      button.addEventListener('click', function() {
        difficultyButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        selectedDifficulty = this.dataset.difficulty;
      });
    });
    
    // When "Start Game" is clicked on the home page, hide home page and show game page.
    document.getElementById("start-game").addEventListener("click", function(){
      selectedSong = document.getElementById("song-select").value;
      document.getElementById("home-page").style.display = "none";
      document.getElementById("game-page").style.display = "flex";
      // After switching pages, the audio will be set up when Play is clicked.
    });

    // -------------------- Game Code Below --------------------
    const gameStage = document.getElementById('game-stage');
    const scoreSpan = document.getElementById('score-value');
    const comboCounter = document.getElementById('combo-counter');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const statusEl = document.getElementById('status');
    const energyBar = document.getElementById('energy-bar');
    const thresholdLine = document.getElementById('threshold-line');
    const debugInfo = document.getElementById('debug-info');
    const debugToggle = document.getElementById('debug-toggle');
    const resultsScreen = document.getElementById('results-screen');
    
    // Results elements
    const finalScoreEl = document.getElementById('final-score');
    const perfectCountEl = document.getElementById('perfect-count');
    const goodCountEl = document.getElementById('good-count');
    const okCountEl = document.getElementById('ok-count');
    const missCountEl = document.getElementById('miss-count');
    const maxComboEl = document.getElementById('max-combo');
    const gradeEl = document.querySelector('.grade');
    const retryButton = document.getElementById('retry-button');
    const homeButton = document.getElementById('home-button');
    
    // Menu elements
    const menu = document.getElementById('menu');
    const menuContent = document.getElementById('menu-content');
    const menuRestart = document.getElementById('menu-restart');
    const menuHome = document.getElementById('menu-home');
    const menuSettings = document.getElementById('menu-settings');
    
    // Settings panel container
    const settingsPanel = document.getElementById('settings-panel');
    
    // Controllers for slider values
    const speedSlider = document.getElementById('speed');
    const speedValue = document.getElementById('speed-value');
    const sensitivitySlider = document.getElementById('sensitivity');
    const sensitivityValue = document.getElementById('sensitivity-value');
    const intervalSlider = document.getElementById('interval');
    const intervalValue = document.getElementById('interval-value');
    const cutoffSlider = document.getElementById('cutoff');
    const cutoffValue = document.getElementById('cutoff-value');
    
    // Debug display elements
    const currentEnergyEl = document.getElementById('current-energy');
    const currentThresholdEl = document.getElementById('current-threshold');
    const beatsDetectedEl = document.getElementById('beats-detected');

    // Game variables
    let score = 0;
    let combo = 0;
    let maxCombo = 0;
    let perfectCount = 0;
    let goodCount = 0;
    let okCount = 0;
    let missCount = 0;
    let activeNotes = [];
    let context, audio, source, analyser, lowPassFilter, dataArray;
    let animationId;
    let gameUpdateId;
    let lastBeatTime = 0;
    let energyHistory = [];
    let beatsDetected = 0;
    let isPlaying = false;
    let noteSpeed = 5;
    let noteTypes = ['circle', 'star', 'square'];
    let noteLanes = [0, 1, 2];
    let songDuration = 0;
    let songEndTimer;
    
    // Key mappings for the lanes
    const keyMap = {
      'a': 0, 'arrowleft': 0,
      's': 1, 'arrowdown': 1,
      'd': 2, 'arrowright': 2
    };
    
    // Initialize game
    function initGame() {
      // Clear stage of existing notes
      const existingNotes = document.querySelectorAll('.note');
      existingNotes.forEach(note => note.remove());
      
      // Reset game stats
      score = 0;
      combo = 0;
      maxCombo = 0;
      perfectCount = 0;
      goodCount = 0;
      okCount = 0;
      missCount = 0;
      activeNotes = [];
      
      // Update display
      scoreSpan.textContent = score;
      comboCounter.textContent = combo;
      
      // Set note speed based on difficulty and slider
      noteSpeed = parseInt(speedSlider.value);
      // Adjust for selected difficulty
      if (selectedDifficulty === "medium") {
        noteSpeed *= 1.3;
      } else if (selectedDifficulty === "hard") {
        noteSpeed *= 1.6;
      }
    }
    
    // Create a new note to fall down a lane
    function createNote(laneIndex) {
      const noteType = noteTypes[Math.floor(Math.random() * noteTypes.length)];
      const lane = document.querySelectorAll('.lane')[laneIndex];
      const note = document.createElement('div');
      note.classList.add('note', 'note-' + noteType);
      note.dataset.lane = laneIndex;
      note.dataset.top = "-30"; // Starting position above the screen
      note.style.top = "-30px";
      note.style.left = "50%";
      
      // Add number/shape inside the note
      note.textContent = Math.floor(Math.random() * 9) + 1;
      
      lane.appendChild(note);
      
      // Add to active notes
      activeNotes.push({
        element: note,
        lane: laneIndex,
        type: noteType,
        position: -30,
        hit: false,
        missed: false
      });
    }
    
    // Update note positions
    function updateNotes() {
      if (!isPlaying) return;
      
      // Move notes down
      for (let i = activeNotes.length - 1; i >= 0; i--) {
        const note = activeNotes[i];
        if (note.hit || note.missed) continue;
        
        note.position += noteSpeed;
        note.element.style.top = note.position + "px";
        
        // Check if note should be removed (passed bottom of screen)
        if (note.position > 480) {
          // Mark as missed if not yet hit
          if (!note.hit) {
            note.missed = true;
            missCount++;
            combo = 0;
            comboCounter.textContent = combo;
            showFeedback(note.lane, "miss");
          }
          
          // Remove from DOM
          note.element.remove();
          // Remove from active notes array
          activeNotes.splice(i, 1);
        }
      }
      
      gameUpdateId = requestAnimationFrame(updateNotes);
    }
    
    // Handle key presses
    document.addEventListener('keydown', (e) => {
      if (!isPlaying) return;
      
      const key = e.key.toLowerCase();
      const laneIndex = keyMap[key];
      
      if (laneIndex !== undefined) {
        checkHit(laneIndex);
      }
    });
    
    // Handle lane clicks (mobile support)
    document.querySelectorAll('.lane').forEach((lane, index) => {
      lane.addEventListener('click', () => {
        if (!isPlaying) return;
        checkHit(index);
      });
    });
    
    // Check if a hit was successful
    function checkHit(laneIndex) {
      const targetZoneTop = 380; // Target zone top position
      const targetZoneBottom = 420; // Target zone bottom position
      let closestNote = null;
      let closestDistance = Infinity;
      
      // Find closest note in the correct lane
      for (const note of activeNotes) {
        if (note.lane === laneIndex && !note.hit && !note.missed) {
          const noteCenter = note.position + 15; // Center of the note
          const distance = Math.abs(noteCenter - 400); // Distance to target center
          
          if (distance < closestDistance) {
            closestDistance = distance;
            closestNote = note;
          }
        }
      }
      
      if (closestNote) {
        const noteCenter = closestNote.position + 15;
        
        // Check if within target zone
        if (noteCenter >= targetZoneTop && noteCenter <= targetZoneBottom) {
          closestNote.hit = true;
          
          // Calculate accuracy
          const targetCenter = (targetZoneTop + targetZoneBottom) / 2;
          const accuracy = Math.abs(noteCenter - targetCenter);
          
          let points = 0;
          let feedback = "";
          
          // Score based on accuracy
          if (accuracy < 5) {
            // Perfect hit
            points = 300;
            feedback = "perfect";
            perfectCount++;
          } else if (accuracy < 15) {
            // Good hit
            points = 200;
            feedback = "good";
            goodCount++;
          } else {
            // OK hit
            points = 100;
            feedback = "ok";
            okCount++;
          }
          
          // Apply combo multiplier
          combo++;
          if (combo > maxCombo) {
            maxCombo = combo;
          }
          
          // Apply combo bonus
          if (combo > 10) {
            points = Math.floor(points * 1.5);
          } else if (combo > 5) {
            points = Math.floor(points * 1.2);
          }
          
          // Special bonus for star notes
          if (closestNote.type === 'star') {
            points *= 2;
          }
          
          // Update score
          score += points;
          scoreSpan.textContent = score;
          comboCounter.textContent = combo;
          
          // Show hit effect and feedback
          showHitEffect(laneIndex);
          showFeedback(laneIndex, feedback);
          
          // Remove note element
          closestNote.element.remove();
          // Remove from active notes array
          const index = activeNotes.indexOf(closestNote);
          if (index > -1) {
            activeNotes.splice(index, 1);
          }
        } else if (noteCenter < targetZoneTop && noteCenter > targetZoneTop - 100) {
          // Too early - small penalty
          showFeedback(laneIndex, "miss");
          combo = 0;
          comboCounter.textContent = combo;
        }
      }
    }
    
    // Show hit effect animation
    function showHitEffect(laneIndex) {
      const lane = document.querySelectorAll('.lane')[laneIndex];
      const effect = document.createElement('div');
      effect.classList.add('hit-effect');
      effect.style.left = "50%";
      effect.style.bottom = "60px";
      effect.style.transform = "translate(-50%, 0) scale(0)";
      
      lane.appendChild(effect);
      
      // Trigger animation
      setTimeout(() => {
        effect.style.transform = "translate(-50%, 0) scale(1)";
        effect.style.opacity = "1";
      }, 10);
      
      // Remove after animation
      setTimeout(() => {
        effect.style.transform = "translate(-50%, 0) scale(1.5)";
        effect.style.opacity = "0";
        setTimeout(() => effect.remove(), 300);
      }, 300);
    }
    
    // Show feedback text (Perfect, Good, etc.)
    function showFeedback(laneIndex, type) {
      const lane = document.querySelectorAll('.lane')[laneIndex];
      const feedback = document.createElement('div');
      feedback.classList.add('feedback', type);
      feedback.textContent = type.toUpperCase();
      feedback.style.left = "50%";
      feedback.style.bottom = "100px";
      feedback.style.transform = "translateX(-50%)";
      
      lane.appendChild(feedback);
      
      // Hide after a short delay
      setTimeout(() => {
        feedback.classList.add('hidden');
        setTimeout(() => feedback.remove(), 500);
      }, 500);
    }
    
    // Audio beat detection
    function detectBeat() {
      if (!isPlaying) return;
      analyser.getByteFrequencyData(dataArray);
      const cutoffFreq = parseInt(cutoffSlider.value);
      const bassBins = Math.floor(cutoffFreq * analyser.frequencyBinCount / (context.sampleRate / 2));
      let bassEnergy = 0;
      for (let i = 0; i < bassBins; i++) {
        const weight = 1 - (i / bassBins);
        bassEnergy += dataArray[i] * weight;
      }
      bassEnergy = bassEnergy / bassBins * 2;
      energyBar.style.height = Math.min(100, bassEnergy / 2.55) + '%';
      energyHistory.push(bassEnergy);
      if (energyHistory.length > 50) energyHistory.shift();
      const avgEnergy = energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length;
      const varianceEnergy = energyHistory.reduce((a, b) => a + Math.pow(b - avgEnergy, 2), 0) / energyHistory.length;
      const standardDeviation = Math.sqrt(varianceEnergy);
      const sensitivity = parseInt(sensitivitySlider.value);
      const sensitivityFactor = (11 - sensitivity) * 0.2;
      const threshold = avgEnergy + (standardDeviation * sensitivityFactor);
      thresholdLine.style.bottom = Math.min(100, threshold / 2.55) + '%';
      if (debugInfo.style.display === 'block') {
        currentEnergyEl.textContent = Math.round(bassEnergy);
        currentThresholdEl.textContent = Math.round(threshold);
        beatsDetectedEl.textContent = beatsDetected;
      }
      const now = context.currentTime;
      const minTimeBetweenBeats = parseInt(intervalSlider.value) / 1000;
      if (bassEnergy > threshold && now - lastBeatTime > minTimeBetweenBeats) {
        lastBeatTime = now;
        beatsDetected++;
        // Create a new note on a random lane
        createNote(Math.floor(Math.random() * 3));
      }
      animationId = requestAnimationFrame(detectBeat);
    }
    
    // Set up audio context
    function setupAudio() {
      try {
        // Create audio context if it doesn't exist
        if (!context) {
          context = new (window.AudioContext || window.webkitAudioContext)();
          analyser = context.createAnalyser();
          analyser.fftSize = 256;
          lowPassFilter = context.createBiquadFilter();
          lowPassFilter.type = "lowpass";
          lowPassFilter.frequency.value = parseInt(cutoffSlider.value);
          dataArray = new Uint8Array(analyser.frequencyBinCount);
        }
        
        // If audio is already set up, just resume context
        if (context.state === 'suspended') {
          context.resume();
        }
        
        return true;
      } catch (e) {
        console.error("Audio setup failed:", e);
        statusEl.textContent = "Audio setup failed. Please try again.";
        return false;
      }
    }
    
    // Load and play selected song
    function playSong() {
      if (!setupAudio()) return;
      
      // Stop any existing audio
      if (source) {
        source.stop();
        cancelAnimationFrame(animationId);
        cancelAnimationFrame(gameUpdateId);
      }
      
      initGame();
      
      // Create new audio source based on selection
      if (selectedSong.startsWith("http")) {
        // Handle external URLs
        fetch(selectedSong)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => context.decodeAudioData(arrayBuffer))
          .then(audioBuffer => {
            source = context.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(lowPassFilter);
            lowPassFilter.connect(analyser);
            analyser.connect(context.destination);
            
            // Start audio
            source.start(0);
            isPlaying = true;
            statusEl.textContent = "Playing: " + selectedSong.split('/').pop();
            
            // Set up beat detection
            detectBeat();
            updateNotes();
            
            // Set timer for song end
            songDuration = audioBuffer.duration;
            clearTimeout(songEndTimer);
            songEndTimer = setTimeout(endGame, songDuration * 1000);
          })
          .catch(e => {
            console.error("Audio loading failed:", e);
            statusEl.textContent = "Failed to load audio. Please try another song.";
            // Fall back to simulation if loading fails
            simulateExternalAudio();
          });
      }
    }
    
    // Simulate audio for external URLs (like YouTube)
    function simulateExternalAudio() {
      isPlaying = true;
      statusEl.textContent = "Simulating beats for selected song";
      
      // Start beat simulation
      detectBeat();
      updateNotes();
      
      // Simulate random beat generation
      const beatInterval = setInterval(() => {
        if (!isPlaying) {
          clearInterval(beatInterval);
          return;
        }
        createNote(Math.floor(Math.random() * 3));
      }, 600 - (selectedDifficulty === 'easy' ? 200 : selectedDifficulty === 'medium' ? 100 : 0));
      
      // Set song duration (3 minutes for simulation)
      clearTimeout(songEndTimer);
      songEndTimer = setTimeout(endGame, 180000);
    }
    
    // End game and show results
    function endGame() {
      isPlaying = false;
      cancelAnimationFrame(animationId);
      cancelAnimationFrame(gameUpdateId);
      
      // Stop audio if playing
      if (source) {
        source.stop();
      }
      
      // Calculate grade
      let grade = 'D';
      const totalHits = perfectCount + goodCount + okCount;
      const accuracy = totalHits > 0 ? (perfectCount * 1 + goodCount * 0.7 + okCount * 0.3) / totalHits : 0;
      
      if (accuracy > 0.9) {
        grade = 'S';
      } else if (accuracy > 0.8) {
        grade = 'A';
      } else if (accuracy > 0.6) {
        grade = 'B';
      } else if (accuracy > 0.4) {
        grade = 'C';
      }
      
      // Update results screen
      finalScoreEl.textContent = score;
      perfectCountEl.textContent = perfectCount;
      goodCountEl.textContent = goodCount;
      okCountEl.textContent = okCount;
      missCountEl.textContent = missCount;
      maxComboEl.textContent = maxCombo;
      gradeEl.textContent = grade;
      gradeEl.className = 'grade grade-' + grade;
      
      // Show results screen
      resultsScreen.style.display = 'flex';
    }
    
    // Event listeners for play/pause buttons
    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        playSong();
      }
    });
    
    pauseBtn.addEventListener('click', () => {
      if (isPlaying) {
        isPlaying = false;
        if (source) {
          source.stop();
        }
        cancelAnimationFrame(animationId);
        cancelAnimationFrame(gameUpdateId);
        statusEl.textContent = "Paused";
      }
    });
    
    // Menu event listeners
    menu.addEventListener('click', () => {
      menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
    });
    
    menuRestart.addEventListener('click', () => {
      menuContent.style.display = 'none';
      playSong();
    });
    
    menuHome.addEventListener('click', () => {
      menuContent.style.display = 'none';
      document.getElementById('game-page').style.display = 'none';
      document.getElementById('home-page').style.display = 'flex';
      if (source) {
        source.stop();
      }
      isPlaying = false;
      resultsScreen.style.display = 'none';
    });
    
    menuSettings.addEventListener('click', () => {
      menuContent.style.display = 'none';
      settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block';
    });
    
    // Results screen buttons
    retryButton.addEventListener('click', () => {
      resultsScreen.style.display = 'none';
      playSong();
    });
    
    homeButton.addEventListener('click', () => {
      resultsScreen.style.display = 'none';
      document.getElementById('game-page').style.display = 'none';
      document.getElementById('home-page').style.display = 'flex';
    });
    
    // Slider event listeners
    speedSlider.addEventListener('input', () => {
      speedValue.textContent = speedSlider.value;
      noteSpeed = parseInt(speedSlider.value);
      // Adjust for selected difficulty
      if (selectedDifficulty === "medium") {
        noteSpeed *= 1.3;
      } else if (selectedDifficulty === "hard") {
        noteSpeed *= 1.6;
      }
    });
    
    sensitivitySlider.addEventListener('input', () => {
      sensitivityValue.textContent = sensitivitySlider.value;
    });
    
    intervalSlider.addEventListener('input', () => {
      intervalValue.textContent = intervalSlider.value;
    });
    
    cutoffSlider.addEventListener('input', () => {
      cutoffValue.textContent = cutoffSlider.value;
      if (lowPassFilter) {
        lowPassFilter.frequency.value = parseInt(cutoffSlider.value);
      }
    });
    
    // Debug toggle
    debugToggle.addEventListener('click', () => {
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    });
    
    // Initialize settings panel values
    speedValue.textContent = speedSlider.value;
    sensitivityValue.textContent = sensitivitySlider.value;
    intervalValue.textContent = intervalSlider.value;
    cutoffValue.textContent = cutoffSlider.value;
    
    // Touch support for mobile devices
    document.addEventListener('touchstart', function(e) {
      if (!isPlaying) return;
      
      // Get touch position
      const touchX = e.touches[0].clientX;
      const stageRect = gameStage.getBoundingClientRect();
      
      // Determine which lane was touched
      if (touchX >= stageRect.left && touchX <= stageRect.right) {
        const laneWidth = stageRect.width / 3;
        const laneIndex = Math.floor((touchX - stageRect.left) / laneWidth);
        checkHit(laneIndex);
      }
    }, false);
    
    // Prevent scrolling on touch
    document.addEventListener('touchmove', function(e) {
      if (isPlaying) {
        e.preventDefault();
      }
    }, { passive: false });
  </script>
</body>
</html>